---
paths: ["**/*"]
alwaysApply: true
---

# Workflow Rules - 工作流规则

## 核心工作流程

### 1. 任务接收与理解
当收到新任务时，必须：
- 首先理解任务目标和约束
- 识别任务类型（bug修复/新功能/重构/文档）
- 评估任务复杂度（简单/中等/复杂）
- 如果需求不清晰，先提出澄清问题

### 2. 任务规划
复杂任务（需要多步骤完成）必须：
- 生成任务 DAG（有向无环图）
- 明确各子任务的依赖关系
- 指定每个任务的执行者（子智能体）
- 设定验收标准

### 3. 子智能体调用
调用子智能体时必须：
- 提供清晰的任务描述
- 提供必要的上下文信息
- 明确期望的输出格式
- 等待任务完成后验证结果

### 3.1 C 方案强制：除规划外，全部通过 Bash + Claude Code CLI
为保证“可核查、可追溯”，除 **规划（/plan, DAG 生成）** 外的工作必须满足：
- **实现 / 测试 / 审查** 必须通过 Bash 调用 `claude` CLI 子 agent 完成
- 主控节点（Cursor）不得直接“手写实现代码/手写测试实现/手写审查结论”
- 每次 CLI 调用必须产出 Evidence（EV-ID），并在 `DASHBOARD.md` 中引用

推荐工具：
- `.claude/bin/call_subagent.sh`（单次调用 + 生成 EV）
- `.claude/bin/swe_exec.sh`（串行执行 repo-scout→architect→implementer→tester→reviewer）

### 3.2 命令级强约束（防越权）
- `/test`：必须通过 `.claude/bin/test_exec.sh` 调用 `tester` 子 agent（禁止主控直接跑测试并下结论）
- `/review`：必须通过 `.claude/bin/review_exec.sh` 调用 `reviewer` 子 agent（禁止主控直接输出审查结论）

### 4. 验证与审查
代码变更必须经过：
- 静态检查（lint/typecheck）
- 测试验证（单元测试/集成测试）
- 代码审查（结构化审查清单）

### 5. 状态同步
每个关键节点必须更新 DASHBOARD.md：
- 任务开始时
- 子任务完成时
- 验证结果出来时
- 任务结束时

## 子智能体调用规则

### 调用顺序（典型流程）
1. `repo-scout` - 理解代码库，定位相关代码
2. `architect` - 设计方案（如需要）
3. `implementer` - 实现代码变更
4. `tester` - 验证变更
5. `reviewer` - 代码审查

### 并行调用规则
以下任务可以并行：
- 代码检索的多个独立查询
- 独立模块的实现
- 不同类型的测试

以下任务必须串行：
- 设计 → 实现
- 实现 → 测试
- 测试 → 审查

## 失败处理规则

### 重试策略
- 网络/临时错误：最多重试 3 次
- 测试失败：分析原因后重试
- 验证失败：回到实现阶段修复

### 回滚条件
- 重试 3 次仍失败
- 发现根本性设计问题
- 资源预算耗尽

### 人工介入
以下情况必须请求人工介入：
- 安全敏感操作
- 大范围重构
- 需求存在严重歧义
- 发现潜在架构问题

## 质量门控

### Pre-commit Gate
必须通过：
- [ ] Lint 检查
- [ ] Type 检查
- [ ] 相关单元测试

### Pre-merge Gate
必须通过：
- [ ] 全量测试
- [ ] 代码审查（无阻塞性问题）
- [ ] 验收标准检查

